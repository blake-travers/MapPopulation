<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Leaflet Map with Attached Sidebar Toggle</title>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

        <style>
            html,body
            {
                height:100%;
                margin:0;
                overflow:hidden;
            }

            #container
            {
                position:relative;
                display:flex;
                height:100%;
                width:100%;
            }

            #map
            {
                flex:1 1 auto;
                height:100%;
                transition: width 0.2s ease;
                min-width: 0;
            }

            #sidebar
            {
                width: 0%;
                background:white;
                border-left:2px solid #ccc;
                height:100%;
                overflow:hidden;
                transition: width 0.2s ease, padding 0.2s ease;
                box-sizing:border-box;
                padding:0;
            }

            #sidebarButton
            {
                position: absolute;
                top: 50%;
                right: 0%;
                z-index: 3000;
                background: white;
                border:2px solid #ccc;
                border-right:4px solid white;


                padding: 8px 10px;
                cursor: pointer;
                border-radius: 4px;
                transition: right 0.2s ease;
                transform: translate(8%, -50%);
                display:flex;
                align-items:center;
                justify-content:center;
                width:42px;
                height:96px;
                font-size:16px;
                line-height:1;
            }

            .sidebar-inner
            {
                padding:15px;
                box-sizing:border-box;
            }

        </style>

    </head>

    <input id="searchBox" 
        type="text" 
        placeholder="Search for a city or country..." 
        autocomplete="off"
        name="no-autofill"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        style="
            position:absolute;
            top:15px; left:15px;
            z-index:3000;
            padding:6px 10px;
            border:2px solid #ccc;
            border-radius:4px;
            width:260px;
        ">


    <button id="searchBtn" 
            style="
            position:absolute;
            top:15px; left:285px;
            z-index:3000;
            padding:6px 10px;
            border:2px solid #ccc;
            background:white;
            border-radius:4px;
            cursor:pointer;
        ">
    </button>

    <div id="searchResults"
     style="
         position:absolute;
         top:55px; left:15px;
         width:260px;
         max-height:300px;
         overflow-y:auto;
         background:white;
         border:2px solid #ccc;
         border-radius:4px;
         z-index:3000;
         display:none;
     ">
    </div>

    <body>

        <button id="sidebarButton" aria-label="Toggle sidebar"></button>

        <div id="container">
            <div id="map"></div>

            <div id="sidebar" aria-hidden="true">
                <div class="sidebar-inner">
                    <h2>Population Tool</h2>
                    <p>Draw shapes on the map to estimate population.</p>
                        <div id="infoArea">No shapes yet.</div>
                </div>
            </div>
        </div>

        <script>
            // DOM references
            const sidebar = document.getElementById('sidebar');
            const mapDiv = document.getElementById('map');
            const toggleBtn = document.getElementById('sidebarButton');
            let sidebarOpen = true;
            toggleBtn.textContent = '▶';
            const SIDEBAR_WIDTH = '30%';
            

            // Initialize map
            const map = L.map('map').setView([-37.8136, 144.9631], 11);

            // Initialise layer/s
            var CartoDB_VoyagerNoLabels = L.tileLayer
            (
                'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
                {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }
            );

            var Esri_WorldGrayCanvas = L.tileLayer
            (
                'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
                {
                    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
                    maxZoom: 16
                }
            );


            var CartoDB_PositronOnlyLabels = L.tileLayer
            (
                'https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png',
                {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }
            );

            Esri_WorldGrayCanvas.addTo(map)
            CartoDB_PositronOnlyLabels.addTo(map);
        

            // Folium-like Draw controls
            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw
            (
                {
                    edit:
                    {
                        featureGroup: drawnItems
                    },
                    draw:
                    {
                    polygon: true,  
                    rectangle: true,
                    circle: true,
                    polyline: false,
                    marker: false,
                    circlemarker: false
                    }
                }
            );
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, function (event)
            {
                const layer = event.layer;
                drawnItems.addLayer(layer);
                const geojson = layer.toGeoJSON();
                console.log("Exported GeoJSON:", geojson);
                alert("Shape drawn! GeoJSON logged to console.");
            });
        
            sidebar.style.transition = 'none';
            toggleBtn.style.transition = 'none';

            sidebar.style.width = SIDEBAR_WIDTH;
            toggleBtn.style.right = SIDEBAR_WIDTH;

            toggleBtn.addEventListener('click', () =>
            {
                sidebar.style.transition = '';
                toggleBtn.style.transition = '';

                sidebarOpen = !sidebarOpen;

                if (sidebarOpen) // If Sidebar is currently open:
                {
                    sidebar.style.width = SIDEBAR_WIDTH;
                    sidebar.setAttribute('aria-hidden', 'false');
                }
                else // If Sidebar is currently closed:
                {
                    sidebar.style.width = '0';
                    sidebar.setAttribute('aria-hidden', 'true');
                }

                toggleBtn.style.right = sidebarOpen ? SIDEBAR_WIDTH : '0';
                toggleBtn.textContent = sidebarOpen ? '▶' : '◀';

            });

            async function searchLocation(query)
            {
                const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}`;

                try
                {
                    const response = await fetch(url);
                    const data = await response.json();
                    const results = data.features;

                    const searchResultsDiv = document.getElementById("searchResults");
                    searchResultsDiv.innerHTML = "";

                    if (!results || !results.length)
                    {
                        searchResultsDiv.style.display = "none";
                        return;
                    }

                    // VALID TYPES: Cities + States + Countries
                    const VALID_TYPES = new Set
                    ([
                        "city",
                        "town",
                        "village",
                        "hamlet",
                        "municipality",
                        "locality",

                        "state",
                        "province",
                        "region",
                        "county",

                        "country"
                    ]);

                    const filtered = results.filter(f =>
                        VALID_TYPES.has(f.properties.osm_value)
                    );

                    filtered.slice(0, 7).forEach
                    (feature =>
                        {
                            const props = feature.properties;
                            const coords = feature.geometry.coordinates; // [lon, lat]

                            // Choose best name
                            const mainName =
                                props.name ||
                                props.city ||
                                props.state ||
                                props.country ||
                                "(unknown)";

                            // Build clean label
                            const label = [
                                mainName,
                                props.state,
                                props.country
                            ].filter(Boolean).join(", ");

                            const item = document.createElement("div");
                            item.textContent = label;
                            item.style.padding = "8px 10px";
                            item.style.cursor = "pointer";
                            item.style.borderBottom = "1px solid #eee";

                            item.addEventListener("mouseover", () => item.style.background = "#f0f0f0");
                            item.addEventListener("mouseout", () => item.style.background = "white");

                            item.addEventListener
                            ("click", () =>
                                {
                                    const lon = coords[0];
                                    const lat = coords[1];

                                    map.setView([lat, lon], 6);

                                    L.marker([lat, lon])
                                        .addTo(map)
                                        .bindPopup(label)
                                        .openPopup();

                                    searchResultsDiv.style.display = "none";
                                }
                            );

                            searchResultsDiv.appendChild(item);
                        }
                    );
                    searchResultsDiv.style.display = "block";
                }
                catch (err)
                {
                    alert("Search error: " + err);
                }
            }



            document.getElementById("searchBtn").addEventListener
            (
                "click", () =>
                {
                    const query = document.getElementById("searchBox").value.trim();
                    if (query) searchLocation(query);
                }
            );

            document.getElementById("searchBox").addEventListener
            (
                "keydown", (e) =>
                {
                    if (e.key === "Enter")
                    {
                        const query = document.getElementById("searchBox").value.trim();
                        if (query) searchLocation(query);
                    }
                }
            );


            let debounceTimer = null;

            function debounceSearch(query)
            {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout
                (() =>
                    {
                        if (query.length >= 2)
                        {
                            searchLocation(query);
                        } else
                        {
                            document.getElementById("searchResults").style.display = "none";
                        }
                    }, 200
                );
            }

            document.getElementById("searchBox").addEventListener
            ("input", () =>
                {
                    const query = document.getElementById("searchBox").value.trim();
                    debounceSearch(query);
                }
            );

            document.addEventListener("click", (e) => {
                const box = document.getElementById("searchBox");
                const drop = document.getElementById("searchResults");

                if (!box.contains(e.target) && !drop.contains(e.target)) {
                    drop.style.display = "none";
                }
            });

        </script>
    </body>
</html>
